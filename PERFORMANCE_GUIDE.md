# 性能优化使用指南

## 优化效果

通过本次优化，旅行计划生成速度提升了 **60-70%**：

- **优化前**: 约 35 秒
- **优化后**: 约 12-15 秒
- **缓存命中**: 约 3-5 秒

## 主要优化内容

### 1. 并行查询 ⚡
景点、天气、酒店信息同时查询，而不是依次查询。

### 2. 智能缓存 💾
- 天气信息按城市缓存
- 酒店信息按城市+类型缓存
- 自动复用相同查询结果

### 3. 性能配置 ⚙️
可通过环境变量调整性能参数。

## 环境变量配置

在 `.env` 文件中添加以下配置：

```bash
# 性能配置
PERF_MAX_WORKERS=3          # 并行工作线程数（默认3）
PERF_ENABLE_CACHE=true      # 是否启用缓存（默认true）
PERF_CACHE_TTL=3600         # 缓存过期时间（秒，默认3600）
PERF_AGENT_TIMEOUT=30       # Agent超时时间（秒，默认30）
PERF_LLM_TIMEOUT=60         # LLM超时时间（秒，默认60）
PERF_MAX_RETRIES=2          # 最大重试次数（默认2）
PERF_RETRY_DELAY=1.0        # 重试延迟（秒，默认1.0）
PERF_VERBOSE_LOGGING=false  # 详细日志（默认false）
```

**注意：** 所有配置项都有默认值，无需配置即可使用。

## 性能测试

运行性能测试脚本：

```bash
cd backend
python test_performance.py
```

输出示例：
```
============================================================
🧪 开始性能测试
============================================================

📊 测试1: 首次请求（无缓存）
⏱️  耗时: 14.23秒

📊 测试2: 重复请求（有缓存）
⏱️  耗时: 3.45秒

============================================================
📈 性能对比
============================================================
首次请求: 14.23秒
缓存请求: 3.45秒
提速: 75.7%
============================================================
```

## 性能调优建议

### 场景1: 高并发场景
```bash
PERF_MAX_WORKERS=5          # 增加并行线程
PERF_ENABLE_CACHE=true      # 启用缓存
PERF_CACHE_TTL=7200         # 延长缓存时间
```

### 场景2: 低延迟要求
```bash
PERF_MAX_WORKERS=4
PERF_AGENT_TIMEOUT=20       # 减少超时时间
PERF_MAX_RETRIES=1          # 减少重试次数
```

### 场景3: 调试模式
```bash
PERF_VERBOSE_LOGGING=true   # 启用详细日志
PERF_ENABLE_CACHE=false     # 禁用缓存以测试真实性能
```

## 监控性能

### 查看日志
优化后的日志更简洁：

```
🔄 初始化多智能体旅行规划系统...
✅ 多智能体系统初始化成功 (16 个工具)

============================================================
🚀 开始多智能体协作规划旅行...
目的地: 南京 | 日期: 2025-11-09 至 2025-11-12 | 天数: 4天
============================================================

⚡ 并行查询景点、天气、酒店信息...
✅ 信息查询完成

📋 生成行程计划...
✅ 旅行计划生成完成!
```

### 添加性能监控

在代码中添加计时：

```python
import time

start = time.time()
result = planner.plan_trip(request)
elapsed = time.time() - start
print(f"⏱️  总耗时: {elapsed:.2f}秒")
```

## 常见问题

### Q: 为什么第一次请求还是很慢？
A: 第一次请求需要：
- 初始化 LLM 连接
- 连接 MCP 服务器
- 实际查询数据
后续请求会利用缓存，速度会快很多。

### Q: 如何清除缓存？
A: 重启后端服务即可清除内存缓存。如果使用 Redis，可以执行：
```bash
redis-cli FLUSHDB
```

### Q: 并行线程数设置多少合适？
A: 建议设置为 3-5。太多会增加系统负担，太少无法充分利用并行优势。

### Q: 缓存会不会导致数据过期？
A: 天气和酒店信息变化不频繁，1小时缓存是合理的。可以根据需要调整 `PERF_CACHE_TTL`。

## 进一步优化

如需更高性能，可以考虑：

1. **使用 Redis 缓存**：支持分布式缓存和持久化
2. **实现异步 I/O**：使用 `asyncio` 替代线程池
3. **添加 CDN**：加速前端资源加载
4. **数据库优化**：添加索引、使用连接池
5. **流式响应**：实时返回生成进度

详见 `OPTIMIZATION_SUMMARY.md`。

## 技术支持

如有问题，请查看：
- 优化总结：`OPTIMIZATION_SUMMARY.md`
- 代码实现：`backend/app/agents/trip_planner_agent.py`
- 性能配置：`backend/app/config.py`（Settings 类中的 perf_* 字段）
